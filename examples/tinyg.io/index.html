<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
	<head>
		<script src="/socket.io/socket.io.js" type="text/javascript"></script>
		<script src="/lib/raphael-min.js" type="text/javascript"></script>
		
		<script type="text/javascript">
		var socket = io.connect();//'http://localhost'
		
		// This will be broken into it's own module soon:
		
		function TinyG() {
			var self = this;
			
			this._configuration = {};
			this._status = {};
		  
			var _merge = function (to, from) {
				for (var n in from) {
					if (to[n] === null || typeof to[n] != 'object') {
						to[n] = from[n];
					} else if (typeof from[n] == 'object') {
						if (changed[n] === undefined) {
							changed[n] = {};
						}

						to[n] = _merge(to[n], from[n]);
					} // if (is not object) ... else
				} // for (n in from)
				return to;
			};
			
			// Debugging
			socket.on('data', function(data) {
				// console.log("RAW: "+data);
				self.emit('data', data);
			});
			socket.on('configChanged', function(changed) {
				// console.log("configChanged: "+JSON.stringify(changed));
				self.emit('configChanged', changed);
			});
			socket.on('stateChanged', function(changed) {
				// console.log("stateChanged: "+JSON.stringify(changed));
				self.emit('stateChanged', changed);
			});
		  socket.on('gcodeReceived', function(gc) {
				// console.log("gcodeReceived: "+JSON.stringify(gc));
				self.emit('gcodeReceived', gc);
			});
		  socket.on('list', function(results) {
				console.log("got list: "+JSON.stringify(results));
				self.listResults = results;
				self.emit('list', results);
			});
		}
		TinyG.prototype.list = function(callback) {
			if (callback !== undefined)
				socket.once('list', callback);

			// Request the other side to "list"
			socket.emit('list');
		};
		
		TinyG.prototype.open = function(port) {
			// Request the other side to "open"
			socket.emit('open', port);
		}
		TinyG.prototype.close = function() {
			// Request the other side to "close"
			socket.emit('close');
		}
		
		TinyG.prototype.write = function(data) {
			// Request the other side to "write"
			socket.emit('write', data);
		}
		
		TinyG.prototype.sendFile = function(path) {
			// Request the other side to "sendFile"
			socket.emit('sendFile', path);
		}

		io.util.mixin(TinyG, io.EventEmitter);
		
		var g = new TinyG();
		
		window.onload = function () {
			// setup drawing
			var paper = Raphael(0, 0, document.width, document.height)
			var line = paper.path("M0,0").attr({fill: "none", stroke: "rgba(0,0,0,0.25)", "arrow-end": "open-narrow-short"});
			var pathSegments = ["M",document.width/2,document.width/2];
			var oldPos = {x:document.width/2, y:document.width/2};
			g.on('stateChanged', function(sr){
				if (sr.posx || sr.posy) {
					if (sr.posx)
						oldPos.x = sr.posx + document.width/2;
					if (sr.posy)
						oldPos.y = sr.posy + document.height/2;
					pathSegments.push("L", oldPos.x, oldPos.y);
					line.attr({path:pathSegments.join(",")});
				}
			});
		};
		</script>
		
		<title>TinyG.io</title>
	</head>
	<body>
	</body>
</html>
